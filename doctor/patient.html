<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patient Records - Karshni Eye Care</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f9; }
    header { background: #0a5fa3; color: white; padding: 1rem; text-align: center; }
    .container { max-width: 100%; margin: 1rem auto; background: #fff; padding: 1rem; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    form label { display: block; margin-top: 1rem; font-weight: bold; }
    form input, form textarea, form select { width: 100%; padding: 0.5rem; margin-top: 0.5rem; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    form button { margin-top: 1rem; padding: 0.7rem 1.5rem; background: #0a5fa3; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%; }
    .download-btn, .sort-btn { margin: 1rem 0.5rem 0 0; padding: 0.7rem 1rem; background: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .search-box { margin-top: 1rem; padding: 0.5rem; width: 100%; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    table { width: 100%; margin-top: 1rem; border-collapse: collapse; overflow-x: auto; display: block; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 0.5rem; text-align: left; white-space: nowrap; }
    th { background: #0a5fa3; color: white; }
    .delete-btn, .print-btn, .edit-btn { margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
    .delete-btn { background: #e53935; color: #fff; }
    .print-btn { background: #4caf50; color: #fff; }
    .edit-btn { background: #2196f3; color: #fff; }

    /* Responsive Design */
    @media (max-width: 768px) {
      th, td { font-size: 12px; padding: 0.3rem; }
      form button, .download-btn, .sort-btn { width: 100%; margin: 0.5rem 0; }
      .container { padding: 0.5rem; }
      form label { margin-top: 0.5rem; }
    }

    /* Mobile form cards */
    @media (max-width: 600px) {
      form { display: flex; flex-direction: column; gap: 1rem; }
      form label { font-size: 14px; }
      form input, form textarea, form select { font-size: 14px; padding: 0.4rem; }
      .form-group { background: #f9f9f9; padding: 0.8rem; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    }
  </style>
</head>
<body>
  <header>
    <h1>Admin - Patient Records</h1>
  </header>
  <div class="container">
    <form id="patientForm">
      <div class="form-group">
        <label for="patientId">Patient ID</label>
        <input type="text" id="patientId" required>
      </div>

      <div class="form-group">
        <label for="name">Full Name</label>
        <input type="text" id="name" required>
      </div>

      <div class="form-group">
        <label for="age">Age</label>
        <input type="number" id="age" required>
      </div>

      <div class="form-group">
        <label for="gender">Gender</label>
        <select id="gender">
          <option>Male</option>
          <option>Female</option>
          <option>Other</option>
        </select>
      </div>

      <div class="form-group">
        <label for="phone">Phone (Unique)</label>
        <input type="tel" id="phone" required>
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email">
      </div>

      <div class="form-group">
        <label for="date">Date</label>
        <input type="date" id="date" required>
      </div>

      <div class="form-group">
        <label for="details">Medical Details</label>
        <textarea id="details"></textarea>
      </div>

      <div class="form-group">
        <label for="notes">Doctor's Notes / Prescription</label>
        <textarea id="notes" placeholder="Enter medicines, dosage, or advice..."></textarea>
      </div>

      <button type="submit">Add Patient</button>
    </form>

    <input type="text" id="search" class="search-box" placeholder="Search by name or phone...">

    <button class="download-btn" onclick="downloadCSV()">Download Records as CSV</button>
    <button class="sort-btn" onclick="sortByDate()">Sort by Date (Newest First)</button>

    <div style="overflow-x:auto;">
      <table id="recordsTable">
        <thead>
          <tr>
            <th>Patient ID</th>
            <th>Name</th>
            <th>Age</th>
            <th>Gender</th>
            <th>Phone</th>
            <th>Email</th>
            <th>Date</th>
            <th>Details</th>
            <th>Notes</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const form = document.getElementById('patientForm');
    const tableBody = document.querySelector('#recordsTable tbody');
    const searchBox = document.getElementById('search');
    let patients = JSON.parse(localStorage.getItem('patients')) || [];
    let editIndex = null;

    function renderTable(filter = '') {
      tableBody.innerHTML = '';
      patients
        .filter(p =>
          p.name.toLowerCase().includes(filter.toLowerCase()) ||
          p.phone.includes(filter)
        )
        .forEach((p, index) => {
          const row = `<tr>
            <td>${p.id}</td>
            <td>${p.name}</td>
            <td>${p.age}</td>
            <td>${p.gender}</td>
            <td>${p.phone}</td>
            <td>${p.email}</td>
            <td>${p.date}</td>
            <td>${p.details}</td>
            <td>${p.notes || ''}</td>
            <td>
              <button class="edit-btn" onclick="editRecord(${index})">Edit</button>
              <button class="print-btn" onclick="printRecord(${index})">Print</button>
              <button class="delete-btn" onclick="deleteRecord(${index})">Delete</button>
            </td>
          </tr>`;
          tableBody.innerHTML += row;
        });
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      const phone = document.getElementById('phone').value;

      if (editIndex === null && patients.some(p => p.phone === phone)) {
        alert('Phone number must be unique.');
        return;
      }

      const patient = {
        id: document.getElementById('patientId').value,
        name: document.getElementById('name').value,
        age: document.getElementById('age').value,
        gender: document.getElementById('gender').value,
        phone: phone,
        email: document.getElementById('email').value,
        date: document.getElementById('date').value,
        details: document.getElementById('details').value,
        notes: document.getElementById('notes').value
      };

      if (editIndex !== null) {
        patients[editIndex] = patient;
        editIndex = null;
      } else {
        patients.push(patient);
      }

      localStorage.setItem('patients', JSON.stringify(patients));
      renderTable(searchBox.value);
      form.reset();
    });

    function editRecord(index) {
      const p = patients[index];
      document.getElementById('patientId').value = p.id;
      document.getElementById('name').value = p.name;
      document.getElementById('age').value = p.age;
      document.getElementById('gender').value = p.gender;
      document.getElementById('phone').value = p.phone;
      document.getElementById('email').value = p.email;
      document.getElementById('date').value = p.date;
      document.getElementById('details').value = p.details;
      document.getElementById('notes').value = p.notes;
      editIndex = index;
    }

    function deleteRecord(index) {
      if (confirm('Are you sure you want to delete this record?')) {
        patients.splice(index, 1);
        localStorage.setItem('patients', JSON.stringify(patients));
        renderTable(searchBox.value);
      }
    }

    function printRecord(index) {
      const p = patients[index];
      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write('<h1>Prescription</h1>');
      printWindow.document.write(`<p><b>Patient ID:</b> ${p.id}</p>`);
      printWindow.document.write(`<p><b>Name:</b> ${p.name}</p>`);
      printWindow.document.write(`<p><b>Age:</b> ${p.age}</p>`);
      printWindow.document.write(`<p><b>Gender:</b> ${p.gender}</p>`);
      printWindow.document.write(`<p><b>Phone:</b> ${p.phone}</p>`);
      printWindow.document.write(`<p><b>Email:</b> ${p.email}</p>`);
      printWindow.document.write(`<p><b>Date:</b> ${p.date}</p>`);
      printWindow.document.write(`<p><b>Details:</b> ${p.details}</p>`);
      printWindow.document.write(`<p><b>Doctor's Notes / Prescription:</b> ${p.notes || ''}</p>`);
      printWindow.document.close();
      printWindow.print();
    }

    function downloadCSV() {
      if (patients.length === 0) {
        alert('No records to download.');
        return;
      }
      let csvContent = 'data:text/csv;charset=utf-8,';
      csvContent += 'Patient ID,Name,Age,Gender,Phone,Email,Date,Details,Notes\n';
      patients.forEach(p => {
        csvContent += `${p.id},${p.name},${p.age},${p.gender},${p.phone},${p.email},${p.date},${p.details},${p.notes || ''}\n`;
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', 'patient_records.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function sortByDate() {
      patients.sort((a, b) => new Date(b.date) - new Date(a.date));
      renderTable(searchBox.value);
    }

    searchBox.addEventListener('input', () => renderTable(searchBox.value));

    renderTable();
  </script>
</body>
</html>
